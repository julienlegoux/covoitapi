generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  DRIVER
  ADMIN
}

enum CityTravelType {
  DEPARTURE
  ARRIVAL
}

enum InscriptionStatus {
  ACTIVE
  CANCELLED
  ANONYMIZED
}

model Auth {
  id           String    @id @default(uuid())
  refId        Int       @unique @default(autoincrement()) @map("ref_id")
  email        String    @unique
  password     String
  role         Role      @default(USER)
  anonymizedAt DateTime? @map("anonymized_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User?

  @@map("auths")
}

model User {
  id           String    @id @default(uuid())
  refId        Int       @unique @default(autoincrement()) @map("ref_id")
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  phone        String?
  authRefId    Int       @unique @map("auth_ref_id")
  anonymizedAt DateTime? @map("anonymized_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  auth         Auth           @relation(fields: [authRefId], references: [refId], onDelete: Cascade)
  driver       Driver?
  inscriptions Inscription[]

  @@map("users")
}

model Driver {
  id            String    @id @default(uuid())
  refId         Int       @unique @default(autoincrement()) @map("ref_id")
  driverLicense String    @unique @map("driver_license")
  userRefId     Int       @unique @map("user_ref_id")
  anonymizedAt  DateTime? @map("anonymized_at")

  user    User     @relation(fields: [userRefId], references: [refId], onDelete: Cascade)
  travels Travel[]
  cars    Car[]

  @@map("drivers")
}

model Travel {
  id           String   @id @default(uuid())
  refId        Int      @unique @default(autoincrement()) @map("ref_id")
  dateRoute    DateTime @map("date_route")
  kms          Int
  seats        Int
  driverRefId  Int      @map("driver_ref_id")
  carRefId     Int      @map("car_ref_id")

  driver       Driver          @relation(fields: [driverRefId], references: [refId], onDelete: Cascade)
  car          Car             @relation(fields: [carRefId], references: [refId], onDelete: Restrict)
  inscriptions Inscription[]
  cities       CityTravel[]

  @@map("routes")
}

model Inscription {
  id           String            @id @default(uuid())
  refId        Int               @unique @default(autoincrement()) @map("ref_id")
  createdAt    DateTime          @default(now()) @map("created_at")
  userRefId    Int               @map("user_ref_id")
  routeRefId   Int               @map("route_ref_id")
  status       InscriptionStatus @default(ACTIVE)

  user   User   @relation(fields: [userRefId], references: [refId], onDelete: Cascade)
  travel Travel @relation(fields: [routeRefId], references: [refId], onDelete: Cascade)

  @@unique([userRefId, routeRefId])
  @@map("inscriptions")
}

model City {
  id       String @id @default(uuid())
  refId    Int    @unique @default(autoincrement()) @map("ref_id")
  cityName String @map("city_name")
  zipcode  String

  travels CityTravel[]

  @@map("cities")
}

model CityTravel {
  routeRefId Int            @map("route_ref_id")
  cityRefId  Int            @map("city_ref_id")
  type       CityTravelType

  travel Travel @relation(fields: [routeRefId], references: [refId], onDelete: Cascade)
  city   City   @relation(fields: [cityRefId], references: [refId], onDelete: Cascade)

  @@id([routeRefId, cityRefId])
  @@map("city_routes")
}

model Car {
  id          String @id @default(uuid())
  refId       Int    @unique @default(autoincrement()) @map("ref_id")
  immat       String @unique
  modelRefId  Int    @map("model_ref_id")
  driverRefId Int    @map("driver_ref_id")

  model   Model    @relation(fields: [modelRefId], references: [refId], onDelete: Restrict)
  driver  Driver   @relation(fields: [driverRefId], references: [refId], onDelete: Cascade)
  travels Travel[]

  @@map("cars")
}

model Model {
  id         String @id @default(uuid())
  refId      Int    @unique @default(autoincrement()) @map("ref_id")
  name       String
  brandRefId Int    @map("brand_ref_id")

  brand  Brand        @relation(fields: [brandRefId], references: [refId], onDelete: Restrict)
  cars   Car[]
  colors ColorModel[]

  @@unique([name, brandRefId])
  @@map("models")
}

model Brand {
  id    String @id @default(uuid())
  refId Int    @unique @default(autoincrement()) @map("ref_id")
  name  String

  models Model[]

  @@map("brands")
}

model Color {
  id    String @id @default(uuid())
  refId Int    @unique @default(autoincrement()) @map("ref_id")
  name  String
  hex   String

  models ColorModel[]

  @@map("colors")
}

model ColorModel {
  colorRefId Int @map("color_ref_id")
  modelRefId Int @map("model_ref_id")

  color Color @relation(fields: [colorRefId], references: [refId], onDelete: Cascade)
  model Model @relation(fields: [modelRefId], references: [refId], onDelete: Cascade)

  @@id([colorRefId, modelRefId])
  @@map("color_models")
}
